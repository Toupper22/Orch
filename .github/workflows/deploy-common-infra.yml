name: Deploy Common Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - test
          - uat
          - prod
      whatIf:
        description: 'Run what-if deployment (preview changes without deploying)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          SUBSCRIPTION_ID=$(jq -r '.subscriptions.${{ inputs.environment }}.subscriptionId' config/subscriptions.json)
          echo "Setting subscription to: $SUBSCRIPTION_ID"
          az account set --subscription "$SUBSCRIPTION_ID"
          az account show

      - name: Validate Bicep template
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          region: westeurope
          template: ./bicep/common/main.bicep
          parameters: ./bicep/common/parameters.${{ inputs.environment }}.json
          deploymentMode: Validate

  preview:
    name: Preview Changes (What-If)
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ inputs.whatIf == true }}
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          SUBSCRIPTION_ID=$(jq -r '.subscriptions.${{ inputs.environment }}.subscriptionId' config/subscriptions.json)
          echo "Setting subscription to: $SUBSCRIPTION_ID"
          az account set --subscription "$SUBSCRIPTION_ID"
          az account show

      - name: Run What-If Analysis
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          region: westeurope
          template: ./bicep/common/main.bicep
          parameters: ./bicep/common/parameters.${{ inputs.environment }}.json
          additionalArguments: --what-if

  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ inputs.whatIf == false }}
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          SUBSCRIPTION_ID=$(jq -r '.subscriptions.${{ inputs.environment }}.subscriptionId' config/subscriptions.json)
          echo "Setting subscription to: $SUBSCRIPTION_ID"
          az account set --subscription "$SUBSCRIPTION_ID"
          az account show

      - name: Deploy Common Infrastructure
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          region: westeurope
          template: ./bicep/common/main.bicep
          parameters: ./bicep/common/parameters.${{ inputs.environment }}.json
          deploymentName: common-infra-${{ inputs.environment }}-${{ github.run_number }}
          failOnStdErr: false

      - name: Output Deployment Results
        run: |
          SUBSCRIPTION_ID=$(jq -r '.subscriptions.${{ inputs.environment }}.subscriptionId' config/subscriptions.json)
          SUBSCRIPTION_NAME=$(jq -r '.subscriptions.${{ inputs.environment }}.subscriptionName' config/subscriptions.json)

          echo "## Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Subscription:** $SUBSCRIPTION_NAME ($SUBSCRIPTION_ID)" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Name:** common-infra-${{ inputs.environment }}-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.deploy.outputs.resourceGroupName }}" >> $GITHUB_STEP_SUMMARY
          echo "**Key Vault:** ${{ steps.deploy.outputs.keyVaultName }}" >> $GITHUB_STEP_SUMMARY
          echo "**Storage Account:** ${{ steps.deploy.outputs.storageAccountName }}" >> $GITHUB_STEP_SUMMARY
          echo "**App Service Plan:** ${{ steps.deploy.outputs.appServicePlanName }}" >> $GITHUB_STEP_SUMMARY
          echo "**Managed Identity:** ${{ steps.deploy.outputs.managedIdentityName }}" >> $GITHUB_STEP_SUMMARY
          echo "**Virtual Network:** ${{ steps.deploy.outputs.virtualNetworkName }}" >> $GITHUB_STEP_SUMMARY
          echo "**NAT Gateway:** ${{ steps.deploy.outputs.natGatewayName }}" >> $GITHUB_STEP_SUMMARY
          echo "**Public IP:** ${{ steps.deploy.outputs.publicIpAddress }}" >> $GITHUB_STEP_SUMMARY

      - name: Azure Logout
        if: always()
        run: az logout
